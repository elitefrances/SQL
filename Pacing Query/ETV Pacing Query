
-- Create 'this month' data
SET time_zone = `America/Los_Angeles`;
drop table ZMMasterPacing;
create table ZMMasterPacing as
select date,
campaign,
device,
CASE
WHEN device = "CTV" THEN 0
WHEN device = "Desktop" THEN 0
WHEN device = "Mobile App" THEN sum(impressions)
WHEN device = "Mobile Web" THEN sum(impressions)
ELSE 0
END as `Mobile_Imps`,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(complete) as completes,
sum(spend) as spend
from Datorama.ZMMasterVideo
group by 1,2,3;

drop table ZMMasterDisplayPacing;
create table ZMMasterDisplayPacing as
select date,
campaign,
device,
CASE
WHEN device = "CTV" THEN 0
WHEN device = "Desktop" THEN 0
WHEN device = "Mobile App" THEN sum(impressions)
WHEN device = "Mobile Web" THEN sum(impressions)
ELSE 0
END as `Mobile_Imps`,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(spend) as spend,
0 as completes
from Datorama.ZMMasterDisplay
group by 1,2,3;

insert into ZMMasterPacing
select * from ZMMasterDisplayPacing;


-- Pacing Sheet

SET time_zone = `America/Los_Angeles`;
drop table `ZM Pacing Tracking Test`;
create table `ZM Pacing Tracking Test` as
select Final.Advertiser, 
Final.Campaign, 
Final.Market, 
Final.Organization, 
Final.Platform,
Final.`Live Date`, 
Final.`End Date`, 
Final.`Analyst`, 
Final.`AM Team`, 
Final.`Tier`,
Final.`AM Status`, 
Final.Impressions, 
Final.`Updated June Goal`,
Final.`Monthly Flag`, 
GREATEST(CAST(((Final.`Days Passed`)/Final.`Monthly Days`) * 
Final.`Updated June Goal` as signed),0) as Expected,
CAST(CASE WHEN STR_TO_DATE(Final.`End Date`, '%m/%d/%Y') < CURDATE() THEN Final.Impressions/CAST(Final.`Updated June Goal` as signed)
	ELSE Final.Impressions/CAST(((Final.`Days Passed`)/Final.`Monthly Days`) * Final.`Updated June Goal` as signed)
	END as CHAR(4)) as Delta, 
CAST(Final.Clicks/Final.Impressions*100 as DECIMAL(10,4)) as `June CTR`,
CAST(Final.completes/Final.Impressions*100 as DECIMAL(10,1)) as `June VCR`,
Final.`May CTR` as `May CTR`,
CAST((Yesterday.Clicks + TwoDays.Clicks + ThreeDays.Clicks) / (Yesterday.Impressions + TwoDays.Impressions + ThreeDays.Impressions) *100 as DECIMAL(10,3)) as `L3D CTR`,
GREATEST(CAST((Final.`Updated June Goal`-
Final.Impressions)/(Final.`Monthly Days` - (Final.`Days Passed`)) as signed),0) 
as DailyRemaining,
CAST(Final.`Mobile %`*100 as DECIMAL(10, 1)) as `Mobile %`,
Yesterday.Impressions as Yesterday,
TwoDays.Impressions As `Two Days Ago`,
ThreeDays.Impressions As `Three Days Ago`,
CAST(Final.CPM as Decimal(10,2)) as CPM,
tz.timezone as `Timezone`,
Final.Tactic,
Final.Notes
from
(Select a.Advertiser,
a.Campaign, 
a.Market, 
a.Organization, 
a.Platform,
a.`Live Date`, 
a.`End Date`, 
a.Analyst, 
a.`Tier`, 
a.`AM Team`, 
a.`AM Status`, 
a.`Updated June Goal`, 
a.`Monthly Flag`, 
(DAY(CURDATE()) - DAY(GREATEST(CAST(DATE_FORMAT(NOW() ,'%Y-%m-01') as DATE), STR_TO_DATE(a.`Live Date`, '%m/%d/%Y')))) as `Days Passed`, 
(DAY(LEAST(LAST_DAY(CURDATE()), STR_TO_DATE(a.`End Date`, '%m/%d/%Y'))) - DAY(GREATEST(CAST(DATE_FORMAT(NOW() ,'%Y-%m-01') as DATE), STR_TO_DATE(a.`Live Date`, '%m/%d/%Y'))) + 1) as `Monthly Days`, 
a.`Apr CTR` as `Apr CTR`, 
a.`May CTR` as `May CTR`,
a.Tactic,
a.Notes,
sum(b.Impressions) as Impressions, 
sum(b.clicks) as Clicks, 
sum(b.completes) as completes,
sum(b.Mobile_Imps)/sum(b.Impressions) as `Mobile %`,
sum(b.`spend`)*1000/sum(b.Impressions) as CPM
from `Pacing Monthly Goals` a 
left join `ZMMasterPacing` b 
on a.Campaign = b.campaign
where Platform like "%ETV%"
group by 1,2,3,4,5,6,7,8,9,10,11,12,13
order by 5
) as Final

left join
(select campaign, sum(Impressions) as Impressions, sum(clicks) as Clicks FROM `ZMMasterPacing`
WHERE STR_TO_DATE(`Date`, '%m/%d/%Y') = subdate(current_date, 1)
group by 1) as Yesterday
on Final.Campaign = Yesterday.campaign
left join
(select campaign, sum(Impressions) as Impressions, sum(clicks) as Clicks FROM `ZMMasterPacing`
WHERE STR_TO_DATE(`Date`, '%m/%d/%Y') = subdate(current_date, 2)
group by 1) as TwoDays
on Final.Campaign = TwoDays.campaign
left join
(select campaign, sum(Impressions) as Impressions, sum(clicks) as Clicks FROM `ZMMasterPacing`
WHERE STR_TO_DATE(`Date`, '%m/%d/%Y') = subdate(current_date, 3)
group by 1) as ThreeDays
on Final.Campaign = ThreeDays.campaign
left join 
(select campaign,timezone from time_zone)  as tz
on Final.Campaign=tz.campaign
group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14;

